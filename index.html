<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L74VTBQ20N"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-L74VTBQ20N');
  </script>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="stylesheet" href="./pages/index.css" />

  <title>Test Page</title>
  <script src="/socket.io/socket.io.js"></script>
  <script type="module" src="public/script.js"></script>
</head>

<body>
  <header class="header">
    REPLACEME
    <h1 class="header__title">Hello world!</h1>
    <p>test test test</p>

    <span>New number is </span><span id="number">... incoming</span>
  </header>
  <main>
    <label for="start">Start date:</label>

    <input type="date" id="start" name="trip-start" value="2022-04-20" onchange="dateChanged(this)">

    <div>
      <canvas id="myChart"></canvas>
    </div>

  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const config = {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'My First dataset',
          backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 99, 132)',
          data: [],
        }]
      },
      options: {}
    };
    let myChart;

    function initChart() {

      myChart = new Chart(
        document.getElementById('myChart'),
        config
      );

    }

    initChart();


    function updateChart(cities, activeUsers) {
      config.data.labels = cities;
      config.data.datasets[0].data = activeUsers;
      myChart.update();
    }

    function dateChanged(target) {
      console.log('date changed ', target.value);
      let date = target.value;

      let httpRequest = new XMLHttpRequest();
      httpRequest.open('GET', '/api/active_users.json?date=' + date, true);
      httpRequest.onreadystatechange = function () {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          // Everything is good, the response was received.
          if (httpRequest.status === 200) {
            alert(httpRequest.responseText);
            let parsed = JSON.parse(httpRequest.responseText);
            updateChart(parsed.cities, parsed.activeUsers);
          } else {
            alert('There was a problem with the request.');
          }
        } else {
          // Not ready yet.
        }
      };

      httpRequest.send();
    }

  </script>
</body>

</html>